CREATE DEFINER=`u640280979_iyfdashboard`@`127.0.0.1` PROCEDURE `progressReportGroupWise`(
  IN p_sessionName   VARCHAR(50),
  IN p_selectedYear  INT,
  IN p_selectedMonth INT,
  IN p_facilitatorId VARCHAR(50),
  IN p_groupPrefix   VARCHAR(50)
)
BEGIN

  WITH
    dates AS (
      SELECT DISTINCT
        DATE(AttendanceDate) AS class_date
      FROM u640280979_iyfdashboard.studentAttendance
      WHERE AttendanceSession = p_sessionName
        AND YEAR(AttendanceDate)  = p_selectedYear
        AND MONTH(AttendanceDate) = p_selectedMonth
    ),
    students AS (
      SELECT
        u.user_id,
        u.name,
        u.mobile_number,
        u.chanting_round,
        u.facilitatorId
      FROM u640280979_iyfdashboard.users AS u
      WHERE u.facilitatorId = p_facilitatorId
        AND u.group_name   LIKE CONCAT(p_groupPrefix, '%')
    )

  SELECT
    s.user_id          AS student_id,
    s.name             AS student_name,
    s.mobile_number,
    s.chanting_round,
    s.facilitatorId,
    CAST(
      CONCAT_WS(
        '/',
        SUM(CASE WHEN sa.StudentId IS NOT NULL THEN 1 ELSE 0 END),
        COUNT(*)
      )
      AS CHAR(10) CHARACTER SET utf8
    ) AS GroupRatio
  FROM dates AS d
  CROSS JOIN students AS s
  LEFT JOIN u640280979_iyfdashboard.studentAttendance AS sa
    ON sa.StudentId            = s.user_id
   AND DATE(sa.AttendanceDate) = d.class_date
   AND sa.AttendanceSession    = p_sessionName
  GROUP BY
    s.user_id,
    s.name,
    s.mobile_number,
    s.chanting_round,
    s.facilitatorId
  ORDER BY s.name;

END